<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FFP Ledger â€” Family Football Pick'em</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#2a2f3a; --text:#e6eaf2; --sub:#b7c0d1;
    --accent:#8b5cf6; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}
  header{position:sticky;top:0;background:linear-gradient(180deg,var(--panel),#12151b);border-bottom:1px solid var(--muted);padding:14px 16px;display:flex;gap:12px;align-items:center;z-index:10}
  header h1{font-size:18px;margin:0 6px 0 0;font-weight:700;letter-spacing:.2px}
  .chip{padding:6px 10px;background:var(--muted);border-radius:999px;font-size:12px;color:var(--sub)}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  .panel{background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:16px}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .grow{flex:1 1 240px}
  label{font-size:12px;color:var(--sub);display:block;margin-bottom:6px}
  input[type="number"], select, input[type="text"]{width:100%;padding:10px 12px;background:#0d1016;border:1px solid var(--muted);border-radius:10px;color:var(--text)}
  input[type="checkbox"]{transform:scale(1.2);accent-color:var(--accent)}
  button{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  button.secondary{background:var(--muted);color:var(--text)}
  button.ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .grid{display:grid;gap:10px}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-size:12px;color:var(--sub);text-align:left;padding:0 8px}
  .table td{background:#0d1016;border:1px solid var(--muted);padding:10px 12px;border-radius:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#10141c;border:1px solid var(--muted);font-size:12px;color:var(--sub)}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .card{background:#0d1016;border:1px solid var(--muted);border-radius:14px;padding:12px 14px;min-width:160px}
  .kpi .card .label{font-size:11px;color:var(--sub)}
  .kpi .card .val{font-size:22px;font-weight:800;margin-top:6px}
  .ok{color:var(--accent2)} .warn{color:var(--warn)} .bad{color:var(--danger)}
  .flex{display:flex;align-items:center;gap:10px}
  .right{margin-left:auto}
  .badge{padding:4px 8px;border-radius:8px;background:#10141c;border:1px solid var(--muted);font-size:12px;color:var(--sub)}
  .lock{cursor:pointer;border:1px solid var(--muted);border-radius:10px;padding:8px 10px;background:#10141c;color:var(--sub)}
  .hint{color:var(--sub);font-size:12px}
  .footer{margin:20px auto 40px;color:var(--sub);text-align:center;font-size:12px}
  .member-tag{display:inline-block;margin:2px 6px 2px 0}
  .danger{background:var(--danger)!important}
</style>
</head>
<body>
<header>
  <h1>FFP Ledger</h1>
  <span class="chip">Family Football Pick'em</span>
  <span id="editStatus" class="badge">Viewer mode</span>
  <button id="toggleEdit" class="lock" title="Toggle edit mode (others can view only)">
    ðŸ”’ Toggle Edit
  </button>
  <div class="right flex">
    <button id="exportBtn" class="secondary">Export JSON</button>
    <label class="pill" style="cursor:pointer">
      â¤’ Import JSON <input id="importFile" type="file" accept="application/json" style="display:none">
    </label>
  </div>
</header>

<div class="wrap grid" style="gap:16px">
  <section class="panel">
    <div class="row">
      <div class="grow">
        <label>Season Weeks</label>
        <input id="weeks" type="number" min="1" max="25" value="18" />
      </div>
      <div class="grow">
        <label>Default Weekly Buyâ€‘In ($)</label>
        <input id="buyin" type="number" min="0" step="1" value="10" />
      </div>
      <div class="grow">
        <label>Current Week</label>
        <input id="currentWeek" type="number" min="1" value="1" />
      </div>
      <div class="grow">
        <label>Notes (optional)</label>
        <input id="notes" type="text" placeholder="e.g., Tie rules, playoff weeks, etc." />
      </div>
    </div>
    <div class="hint" style="margin-top:8px">
      Tip: Site is readâ€‘only by default. Add <b>#edit</b> to the URL or click the lock to enable editing for yourself. Data saves to your browser. Export & commit the JSON to share/backup.
    </div>
  </section>

  <section class="panel">
    <div class="row">
      <div class="grow">
        <label>Members & Buyâ€‘ins</label>
        <div id="members"></div>
        <div id="addMemberRow" style="margin-top:10px"></div>
      </div>
      <div class="grow">
        <label>Week Entry</label>
        <div class="row">
          <div class="grow"><label>Week #</label><input id="wk" type="number" min="1" value="1"></div>
          <div class="grow"><label>Payout ($ total)</label><input id="payout" type="number" min="0" step="1" value="30"></div>
        </div>
        <div style="margin-top:10px">
          <label>Paid This Week</label>
          <div id="paidList"></div>
        </div>
        <div style="margin-top:10px">
          <label>Winner(s) This Week</label>
          <div id="winnersList"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="saveWeek">Save Week</button>
          <button id="clearWeek" class="ghost">Clear Week</button>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="row">
      <div class="grow">
        <label>Season Summary</label>
        <div class="kpi" id="kpis"></div>
      </div>
    </div>
    <table class="table" id="summaryTable">
      <thead>
        <tr>
          <th>Member</th>
          <th>Paid ($)</th>
          <th>Winnings ($)</th>
          <th>Net ($)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="panel">
    <label>Weekly Log</label>
    <div id="weekCards" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px"></div>
  </section>
</div>

<div class="footer">v1 â€¢ Singleâ€‘file app â€” no server, no signâ€‘in.</div>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const DEFAULT_MEMBERS = [
  { id:'ducky1982', display:'Ducky1982', name:'Arica', buyin:10 },
  { id:'patriciaharris65', display:'Patriciaharris65', name:'Patricia', buyin:10 },
  { id:'purplegang56', display:'Purplegang56', name:'Dad', buyin:10 },
  { id:'purplesparkle15', display:'Purplesparkle15', name:'Wife', buyin:10 },
  { id:'thepurplecrazygirl24', display:'ThepurpleCrazygirl24', name:'Daughter', buyin:10 },
  { id:'th3commish', display:'Th3C0mmish', name:'You', buyin:10 },
];

const state = {
  meta:{ weeks:18, buyin:10, currentWeek:1, notes:'' },
  members:[...DEFAULT_MEMBERS],
  weeks:{} // e.g., { "1": { paid:["id"], winners:[{id,amount}], payout:30 } }
};

const STORAGE_KEY = 'ffp-ledger-v1';

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const data = JSON.parse(raw);
      Object.assign(state, data);
    }
  }catch(e){ console.warn(e) }
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderAll();
}

function dollars(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:0}) }

function ensureWeek(num){
  const k = String(num);
  if(!state.weeks[k]) state.weeks[k] = { paid:[], winners:[], payout:0 };
  return state.weeks[k];
}

function renderMembers(){
  const box = $('#members');
  box.innerHTML='';
  state.members.forEach(m=>{
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <span class="pill member-tag"># ${m.display}</span>
      <input ${isEdit()? '' : 'disabled'} data-id="${m.id}" class="nm grow" type="text" value="${m.name}" />
      <input ${isEdit()? '' : 'disabled'} data-id="${m.id}" class="bi" type="number" min="0" step="1" value="${m.buyin}"/>
      <button ${isEdit()? '' : 'disabled'} class="ghost rm" data-id="${m.id}">Remove</button>
    `;
    box.appendChild(row);
  });
  const add = $('#addMemberRow');
  add.innerHTML = isEdit() ? `
    <div class="row">
      <input id="newDisp" class="grow" type="text" placeholder="Display (unique id, e.g., Ducky1982)" />
      <input id="newName" class="grow" type="text" placeholder="Name/Nickname" />
      <input id="newBI" type="number" min="0" step="1" value="${state.meta.buyin}" />
      <button id="addMember">Add Member</button>
    </div>` : `<div class="hint">Edit locked. Click ðŸ”’ Toggle Edit or add <b>#edit</b> to the URL.</div>`;

  box.querySelectorAll('.nm').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const m = state.members.find(x=>x.id===inp.dataset.id);
      m.name = inp.value.trim();
      save();
    });
  });
  box.querySelectorAll('.bi').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const m = state.members.find(x=>x.id===inp.dataset.id);
      m.buyin = Number(inp.value)||0;
      save();
    });
  });
  box.querySelectorAll('.rm').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.id;
      state.members = state.members.filter(x=>x.id!==id);
      // Clean from weeks
      for(const k in state.weeks){
        state.weeks[k].paid = state.weeks[k].paid.filter(x=>x!==id);
        state.weeks[k].winners = state.weeks[k].winners.filter(w=>w.id!==id);
      }
      save();
    });
  });

  if(isEdit()){
    $('#addMember').onclick = ()=>{
      const d = $('#newDisp').value.trim();
      if(!d) return alert('Display is required.');
      const id = d.toLowerCase().replace(/[^a-z0-9]+/g,'');
      if(state.members.some(m=>m.id===id)) return alert('ID already exists.');
      state.members.push({ id, display:d, name:($('#newName').value||d), buyin:Number($('#newBI').value)||0 });
      save();
    };
  }
}

function renderPaidAndWinners(){
  const paidBox = $('#paidList'); paidBox.innerHTML='';
  const winBox = $('#winnersList'); winBox.innerHTML='';
  state.members.forEach(m=>{
    const paid = document.createElement('label');
    paid.className='pill';
    paid.style.cursor='pointer';
    paid.innerHTML = `<input ${isEdit()? '' : 'disabled'} type="checkbox" data-id="${m.id}"> ${m.display}`;
    paidBox.appendChild(paid);

    const win = document.createElement('div');
    win.className='row';
    win.innerHTML = `
      <span class="pill" style="min-width:140px">${m.display}</span>
      <input ${isEdit()? '' : 'disabled'} type="number" min="0" step="1" class="winAmt grow" data-id="${m.id}" placeholder="Amount for ${m.display}" />
    `;
    winBox.appendChild(win);
  });
}

function renderMeta(){
  $('#weeks').value = state.meta.weeks;
  $('#buyin').value = state.meta.buyin;
  $('#currentWeek').value = state.meta.currentWeek;
  $('#notes').value = state.meta.notes;
  $('#wk').value = state.meta.currentWeek;
  document.getElementById('editStatus').textContent = isEdit()? 'Edit mode (local only)' : 'Viewer mode';
  document.getElementById('toggleEdit').textContent = isEdit()? 'ðŸ”“ Editing â€” Click to lock' : 'ðŸ”’ Toggle Edit';
}

function computeSummary(){
  const paidBy = {}; const winBy = {};
  state.members.forEach(m=>{ paidBy[m.id]=0; winBy[m.id]=0; });
  let received=0, payout=0, unpaid=0;
  for(const wk in state.weeks){
    const w = state.weeks[wk];
    // paid
    w.paid.forEach(id=>{
      const mb = state.members.find(m=>m.id===id);
      const amt = mb? (mb.buyin||state.meta.buyin): state.meta.buyin;
      paidBy[id] += amt;
      received += amt;
    });
    // winners
    w.winners.forEach(win=>{
      winBy[win.id] += (Number(win.amount)||0);
      payout += (Number(win.amount)||0);
    });
    // unpaid = members who didn't pay this week but expected?
    unpaid += Math.max(0, (state.members.length * state.meta.buyin) - (w.paid.length * state.meta.buyin));
  }
  const bank = received - payout;
  return {paidBy, winBy, received, payout, unpaid, bank};
}

function renderSummary(){
  const {paidBy, winBy, received, payout, unpaid, bank} = computeSummary();
  // KPIs
  const k = $('#kpis'); k.innerHTML='';
  const cards = [
    ['Received', dollars(received), 'ok'],
    ['Payouts', dollars(payout), 'warn'],
    ['Bank Total', dollars(bank), bank>=0? 'ok':'bad'],
    ['Unpaid (expected)', dollars(unpaid), 'bad']
  ];
  for(const [label,val,cls] of cards){
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<div class="label">${label}</div><div class="val ${cls}">${val}</div>`;
    k.appendChild(div);
  }

  // Member table
  const tb = $('#summaryTable tbody'); tb.innerHTML='';
  state.members.forEach(m=>{
    const paid = paidBy[m.id]||0;
    const won = winBy[m.id]||0;
    const net = won - paid;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="pill"># ${m.display}</span> <span class="hint">(${m.name})</span></td>
      <td>${dollars(paid)}</td>
      <td class="${won>0?'ok':''}">${dollars(won)}</td>
      <td class="${net>=0?'ok':'bad'}">${dollars(net)}</td>
    `;
    tb.appendChild(tr);
  });
}

function renderWeekCards(){
  const box = $('#weekCards'); box.innerHTML='';
  const weeks = state.meta.weeks;
  for(let i=1;i<=weeks;i++){
    const w = state.weeks[String(i)] || {paid:[], winners:[], payout:0};
    const card = document.createElement('div');
    card.className='panel';
    const paidTags = w.paid.map(id=>{
      const m = state.members.find(x=>x.id===id);
      return `<span class="pill">${m?m.display:id}</span>`;
    }).join(' ');
    const winTags = w.winners.map(wi=>{
      const m = state.members.find(x=>x.id===wi.id);
      return `<span class="pill">${m?m.display:wi.id}: ${dollars(wi.amount)}</span>`;
    }).join(' ');
    card.innerHTML = `
      <div class="flex">
        <div class="badge">Week ${i}</div>
        <div class="right hint">Payout: <b>${dollars(w.payout||0)}</b></div>
      </div>
      <div style="margin-top:10px">
        <div class="hint">Paid</div>
        <div>${paidTags || '<span class="hint">â€”</span>'}</div>
      </div>
      <div style="margin-top:10px">
        <div class="hint">Winners</div>
        <div>${winTags || '<span class="hint">â€”</span>'}</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="ghost ${isEdit()?'':'danger'}" data-week="${i}" ${isEdit()?'':'disabled'}>Edit</button>
        <button class="danger ${isEdit()?'':'danger'}" data-clear="${i}" ${isEdit()?'':'disabled'}>Reset</button>
      </div>
    `;
    box.appendChild(card);
  }
  // attach edits
  $$('#weekCards [data-week]').forEach(btn=>{
    btn.onclick = ()=>{
      const wk = Number(btn.dataset.week);
      $('#wk').value = wk;
      loadWeekToForm(wk);
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  $$('#weekCards [data-clear]').forEach(btn=>{
    btn.onclick = ()=>{
      if(!confirm('Clear this week?')) return;
      delete state.weeks[String(btn.dataset.clear)];
      save();
    };
  });
}

function loadWeekToForm(weekNum){
  const w = ensureWeek(weekNum);
  $('#payout').value = w.payout||0;
  // clear checks/inputs
  $$('#paidList input[type=checkbox]').forEach(cb=>cb.checked=false);
  $$('#winnersList .winAmt').forEach(inp=>inp.value='');

  w.paid.forEach(id=>{
    const cb = $(`#paidList input[data-id="${id}"]`);
    if(cb) cb.checked = true;
  });
  w.winners.forEach(win=>{
    const inp = $(`#winnersList .winAmt[data-id="${win.id}"]`);
    if(inp) inp.value = win.amount;
  });
}

function isEdit(){ return location.hash.includes('edit') || window.__edit===true; }

function renderAll(){
  renderMeta();
  renderMembers();
  renderPaidAndWinners();
  renderSummary();
  renderWeekCards();
}

function init(){
  load();
  renderAll();
  // meta bindings
  $('#weeks').onchange = e=>{ state.meta.weeks = Math.max(1, Number(e.target.value)||18); save(); };
  $('#buyin').onchange = e=>{ state.meta.buyin = Math.max(0, Number(e.target.value)||10); save(); };
  $('#currentWeek').onchange = e=>{ state.meta.currentWeek = Math.max(1, Number(e.target.value)||1); save(); };
  $('#notes').onchange = e=>{ state.meta.notes = e.target.value; save(); };

  $('#toggleEdit').onclick = ()=>{
    if(isEdit()){ location.hash = ''; window.__edit=false; }
    else { location.hash = '#edit'; window.__edit=true; }
    renderAll();
  };

  // save week
  $('#saveWeek').onclick = ()=>{
    if(!isEdit()){ return alert('Unlock edit mode first (click ðŸ”’ or add #edit to URL).'); }
    const week = Math.max(1, Number($('#wk').value)||1);
    const w = ensureWeek(week);
    // collect paid
    w.paid = $$('#paidList input[type=checkbox]:checked').map(cb=>cb.dataset.id);
    // collect winners
    w.winners = $$('#winnersList .winAmt').map(inp=>({id:inp.dataset.id, amount:Number(inp.value)||0})).filter(x=>x.amount>0);
    // payout total
    const manual = Number($('#payout').value)||0;
    const sumWins = w.winners.reduce((a,b)=>a+(Number(b.amount)||0),0);
    w.payout = manual>0? manual : sumWins;
    state.meta.currentWeek = week;
    save();
    loadWeekToForm(week);
  };

  // clear current week form
  $('#clearWeek').onclick = ()=>{
    $$('#paidList input[type=checkbox]').forEach(cb=>cb.checked=false);
    $$('#winnersList .winAmt').forEach(inp=>inp.value='');
    $('#payout').value = 0;
  };

  // export
  $('#exportBtn').onclick = ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'ffp-ledger.json'; a.click();
    URL.revokeObjectURL(url);
  };

  // import
  $('#importFile').onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const data = JSON.parse(ev.target.result);
        Object.assign(state, data);
        save();
      }catch(err){ alert('Invalid JSON'); }
    };
    reader.readAsText(file);
  };

  // seed initial paid/winner lists with current week data
  loadWeekToForm(state.meta.currentWeek);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
